scope: ResourceGroup
testScenarios:
  - description: test_network_vpn_connection_ipsec
    steps:
      - step: RawStep_2648
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network vnet create
          Connection: keep-alive
          ParameterSetName: '-g -n --address-prefix'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
          accept-language: en-US
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001","name":"cli_test_vpn_connection_ipsec000001","type":"Microsoft.Resources/resourceGroups","location":"westus","tags":{"product":"azurecli","cause":"automation","date":"2021-03-04T07:25:55Z"},"properties":{"provisioningState":"Succeeded"}}
      - step: Create_virtualNetworks_vnet1
        resourceName: virtualNetworks_vnet1
        exampleFile: ../examples/Create_virtualNetworks_vnet1_Generated_2650.json
        operationId: VirtualNetworks_CreateOrUpdate
      - step: Update_virtualNetworks_vnet1_2652
        resourceName: virtualNetworks_vnet1
        operationId: VirtualNetworks_CreateOrUpdate
        resourceUpdate:
          - add: /properties/subnets/0
            value:
              name: FrontEnd
              properties:
                addressPrefix: 10.11.0.0/24
                provisioningState: Succeeded
                delegations: []
                privateEndpointNetworkPolicies: Enabled
                privateLinkServiceNetworkPolicies: Enabled
              id: >-
                /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/virtualNetworks/vnet1/subnets/FrontEnd
              type: Microsoft.Network/virtualNetworks/subnets
      - step: Update_virtualNetworks_vnet1_2654
        resourceName: virtualNetworks_vnet1
        operationId: VirtualNetworks_CreateOrUpdate
        resourceUpdate:
          - add: /properties/subnets/1
            value:
              name: BackEnd
              properties:
                addressPrefix: 10.12.0.0/24
                provisioningState: Succeeded
                delegations: []
                privateEndpointNetworkPolicies: Enabled
                privateLinkServiceNetworkPolicies: Enabled
              id: >-
                /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/virtualNetworks/vnet1/subnets/BackEnd
              type: Microsoft.Network/virtualNetworks/subnets
      - step: Update_virtualNetworks_vnet1_2656
        resourceName: virtualNetworks_vnet1
        operationId: VirtualNetworks_CreateOrUpdate
        resourceUpdate:
          - add: /properties/subnets/2
            value:
              name: GatewaySubnet
              properties:
                addressPrefix: 10.12.255.0/27
                provisioningState: Succeeded
                delegations: []
                privateEndpointNetworkPolicies: Enabled
                privateLinkServiceNetworkPolicies: Enabled
              id: >-
                /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/virtualNetworks/vnet1/subnets/GatewaySubnet
              type: Microsoft.Network/virtualNetworks/subnets
      - step: RawStep_2657
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network public-ip create
          Connection: keep-alive
          ParameterSetName: '-g -n'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
          accept-language: en-US
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001","name":"cli_test_vpn_connection_ipsec000001","type":"Microsoft.Resources/resourceGroups","location":"westus","tags":{"product":"azurecli","cause":"automation","date":"2021-03-04T07:25:55Z"},"properties":{"provisioningState":"Succeeded"}}
      - step: Create_publicIPAddresses_pip1
        resourceName: publicIPAddresses_pip1
        exampleFile: ../examples/Create_publicIPAddresses_pip1_Generated_2659.json
        operationId: PublicIPAddresses_CreateOrUpdate
      - step: RawStep_2660
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network vnet-gateway create
          Connection: keep-alive
          ParameterSetName: '-g -n --public-ip-address --vnet --sku'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
          accept-language: en-US
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001","name":"cli_test_vpn_connection_ipsec000001","type":"Microsoft.Resources/resourceGroups","location":"westus","tags":{"product":"azurecli","cause":"automation","date":"2021-03-04T07:25:55Z"},"properties":{"provisioningState":"Succeeded"}}
      - step: Create_virtualNetworkGateways_gw1
        resourceName: virtualNetworkGateways_gw1
        exampleFile: ../examples/Create_virtualNetworkGateways_gw1_Generated_2662.json
        operationId: VirtualNetworkGateways_CreateOrUpdate
      - step: RawStep_2663
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network local-gateway create
          Connection: keep-alive
          ParameterSetName: '-g -n --gateway-ip-address --local-address-prefixes'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
          accept-language: en-US
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001","name":"cli_test_vpn_connection_ipsec000001","type":"Microsoft.Resources/resourceGroups","location":"westus","tags":{"product":"azurecli","cause":"automation","date":"2021-03-04T07:25:55Z"},"properties":{"provisioningState":"Succeeded"}}
      - step: Create_localNetworkGateways_lgw1
        resourceName: localNetworkGateways_lgw1
        exampleFile: ../examples/Create_localNetworkGateways_lgw1_Generated_2665.json
        operationId: LocalNetworkGateways_CreateOrUpdate
      - step: RawStep_2666
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network vpn-connection create
          Connection: keep-alive
          ParameterSetName: '-g -n --vnet-gateway1 --local-gateway2 --shared-key'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
          accept-language: en-US
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001","name":"cli_test_vpn_connection_ipsec000001","type":"Microsoft.Resources/resourceGroups","location":"westus","tags":{"product":"azurecli","cause":"automation","date":"2021-03-04T07:25:55Z"},"properties":{"provisioningState":"Succeeded"}}
      - step: RawStep_2667
        method: PUT
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Resources/deployments/mock-deployment?api-version=2020-10-01
        requestBody: >-
          {"properties":{"template":{"$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"sharedKey":{"type":"securestring","metadata":{"description":"Secure
          sharedKey"}}},"variables":{},"resources":[{"type":"Microsoft.Network/connections","name":"conn1","location":"westus","tags":{},"apiVersion":"2015-06-15","dependsOn":[],"properties":{"virtualNetworkGateway1":{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/virtualNetworkGateways/gw1"},"enableBgp":false,"connectionType":"IPSec","routingWeight":10,"usePolicyBasedTrafficSelectors":false,"expressRouteGatewayBypass":null,"localNetworkGateway2":{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/localNetworkGateways/lgw1"},"sharedKey":"[parameters('sharedKey')]"}}],"outputs":{"resource":{"type":"object","value":"[reference('conn1')]"}}},"parameters":{"sharedKey":{"value":"AzureA1b2C3"}},"mode":"Incremental"}}
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network vpn-connection create
          Connection: keep-alive
          Content-Length: '1253'
          Content-Type: application/json; charset=utf-8
          ParameterSetName: '-g -n --vnet-gateway1 --local-gateway2 --shared-key'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
          accept-language: en-US
        statusCode: 201
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Resources/deployments/vpn_connection_deploy_7MpRLnv1XvPdBYdhuzJ3KIRJOdBdbfrA","name":"vpn_connection_deploy_7MpRLnv1XvPdBYdhuzJ3KIRJOdBdbfrA","type":"Microsoft.Resources/deployments","properties":{"templateHash":"14475296333956763162","parameters":{"sharedKey":{"type":"SecureString"}},"mode":"Incremental","provisioningState":"Accepted","timestamp":"2021-03-04T08:03:34.458326Z","duration":"PT2.9255654S","correlationId":"10f4527f-4426-4e13-84e5-b1a51e1e3a94","providers":[{"namespace":"Microsoft.Network","resourceTypes":[{"resourceType":"connections","locations":["westus"]}]}],"dependencies":[]}}
      - step: RawStep_2668
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Resources/deployments/mock-deployment/operationStatuses/08585867618739448538?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network vpn-connection create
          Connection: keep-alive
          ParameterSetName: '-g -n --vnet-gateway1 --local-gateway2 --shared-key'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
        responseExpected: '{"status":"Running"}'
      - step: RawStep_2669
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Resources/deployments/mock-deployment/operationStatuses/08585867618739448538?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network vpn-connection create
          Connection: keep-alive
          ParameterSetName: '-g -n --vnet-gateway1 --local-gateway2 --shared-key'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
        responseExpected: '{"status":"Succeeded"}'
      - step: RawStep_2670
        method: GET
        rawUrl: >-
          https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Resources/deployments/mock-deployment?api-version=2020-10-01
        requestHeaders:
          Accept: application/json
          Accept-Encoding: gzip, deflate
          CommandName: network vpn-connection create
          Connection: keep-alive
          ParameterSetName: '-g -n --vnet-gateway1 --local-gateway2 --shared-key'
          User-Agent: >-
            python/3.7.3 (Windows-10-10.0.19041-SP0) msrest/0.6.21
            msrest_azure/0.6.3 azure-mgmt-resource/12.0.0 Azure-SDK-For-Python
            AZURECLI/2.20.0
        responseExpected: >-
          {"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Resources/deployments/vpn_connection_deploy_7MpRLnv1XvPdBYdhuzJ3KIRJOdBdbfrA","name":"vpn_connection_deploy_7MpRLnv1XvPdBYdhuzJ3KIRJOdBdbfrA","type":"Microsoft.Resources/deployments","properties":{"templateHash":"14475296333956763162","parameters":{"sharedKey":{"type":"SecureString"}},"mode":"Incremental","provisioningState":"Succeeded","timestamp":"2021-03-04T08:04:15.1139507Z","duration":"PT43.5811901S","correlationId":"10f4527f-4426-4e13-84e5-b1a51e1e3a94","providers":[{"namespace":"Microsoft.Network","resourceTypes":[{"resourceType":"connections","locations":["westus"]}]}],"dependencies":[],"outputs":{"resource":{"type":"Object","value":{"provisioningState":"Succeeded","resourceGuid":"6b987140-5819-4fe1-9128-07abaeb49001","virtualNetworkGateway1":{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/virtualNetworkGateways/gw1"},"localNetworkGateway2":{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/localNetworkGateways/lgw1"},"connectionType":"IPsec","connectionProtocol":"IKEv2","routingWeight":10,"sharedKey":"AzureA1b2C3","enableBgp":false,"useLocalAzureIpAddress":false,"trafficSelectorPolicies":[],"connectionStatus":"Unknown","ingressBytesTransferred":0,"egressBytesTransferred":0,"dpdTimeoutSeconds":0,"connectionMode":"Default"}}},"outputResources":[{"id":"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/cli_test_vpn_connection_ipsec000001/providers/Microsoft.Network/connections/conn1"}]}}
      - step: VirtualNetworkGatewayConnections_Get_2671
        exampleFile: ../examples/VirtualNetworkGatewayConnections_Get_2671_Generated.json
        operationId: VirtualNetworkGatewayConnections_Get
      - step: Create_connections_conn1
        resourceName: connections_conn1
        exampleFile: ../examples/Create_connections_conn1_Generated.json
        operationId: VirtualNetworkGatewayConnections_CreateOrUpdate
      - step: Update_connections_conn1_2674
        resourceName: connections_conn1
        operationId: VirtualNetworkGatewayConnections_CreateOrUpdate
        resourceUpdate:
          - remove: /properties/ipsecPolicies/0
    variables:
      virtualNetworkName: vnet1
      publicIpAddressName: pip1
      virtualNetworkGatewayName: gw1
      localNetworkGatewayName: lgw1
      virtualNetworkGatewayConnectionName: conn1
