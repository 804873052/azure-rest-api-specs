# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-rest-api-specs/main/documentation/api-scenario/references/v1.2/schema.json

scope: ResourceGroup

variables:
  nameSeed:
    type: string
    prefix: ""
  profileName: afdx-p-$(nameSeed)
  originGroupName: afdx-og-$(nameSeed)
  originName: afdx-o-$(nameSeed)
  endpointName: afdx-ed-$(nameSeed)
  routeName: afdx-r-$(nameSeed)
  ruleSetName: ruleSet1
  ruleName: rule1

scenarios:
  - scenario: quickStart
    variables:
      rule:
        type: object
        value:
          properties:
            order: 1
            conditions:
              - name: RequestMethod
                parameters:
                  typeName: DeliveryRuleRequestMethodConditionParameters
                  operator: Equal
                  matchValues:
                    - GET
                  negateCondition: false
            actions:
              - name: ModifyResponseHeader
                parameters:
                  typeName: DeliveryRuleHeaderActionParameters
                  headerAction: Overwrite
                  headerName: X-CDN
                  value: MSFT
    steps:
      # Profiles
      - operationId: Profiles_Create
        parameters:
          profile:
            location: Global
            sku:
              name: Standard_AzureFrontDoor
            properties:
              originResponseTimeoutSeconds: 60
      - operationId: AFDProfiles_CheckHostNameAvailability
        parameters:
          checkHostNameAvailabilityInput:
            hostName: azure.com
      - operationId: AFDProfiles_ListResourceUsage

      # AFD endpoints
      - operationId: CheckEndpointNameAvailability
        parameters:
          checkEndpointNameAvailabilityInput:
            name: $(endpointName)
            type: Microsoft.Cdn/Profiles/AfdEndpoints
            autoGeneratedDomainNameLabelScope: TenantReuse
      - operationId: AFDEndpoints_Create
        parameters:
          endpoint:
            location: Global
            properties:
              enabledState: Enabled
      - operationId: AFDEndpoints_Get
      - operationId: AFDEndpoints_Update
        parameters:
          endpointUpdateProperties:
            tags:
              hello: world
          properties:
            enabledState: Disabled
      - operationId: AFDEndpoints_Update
        parameters:
          endpointUpdateProperties:
            tags:
              foo: bar
              rg: $(resourceGroupName)
          properties:
            enabledState: Enabled
      - operationId: AFDEndpoints_ListByProfile
      - operationId: AFDEndpoints_ListResourceUsage
      - operationId: AFDEndpoints_PurgeContent
        parameters:
          contents:
            contentPaths:
              - /folder1
            domains:
              - endpoint1.azureedge.net

      # AFD Origins
      - operationId: AFDOriginGroups_Create
        parameters:
          originGroup:
            properties:
              loadBalancingSettings:
                sampleSize: 4
                successfulSamplesRequired: 3
                additionalLatencyInMilliseconds: 50
              healthProbeSettings:
                probePath: /
                probeRequestType: HEAD
                probeProtocol: Http
                probeIntervalInSeconds: 100
              sessionAffinityState: Disabled
      - operationId: AFDOriginGroups_Get
      - operationId: AFDOriginGroups_ListByProfile
      - operationId: AFDOriginGroups_ListResourceUsage
      - operationId: AFDOrigins_Create
        parameters:
          origin:
            properties:
              hostName: portal.test.azure-devex-tools.com
              httpPort: 80
              httpsPort: 443
              originHostHeader: portal.test.azure-devex-tools.com
              priority: 1
              weight: 1000
              enabledState: Enabled
              enforceCertificateNameCheck: true
      - operationId: AFDOrigins_Get
      - operationId: AFDOrigins_Update
        parameters:
          originUpdateProperties:
            properties:
              hostName: validate.test.azure-devex-tools.com
              httpPort: 8080
              httpsPort: 8443
              enabledState: Disabled
      - operationId: AFDOrigins_Update
        parameters:
          originUpdateProperties:
            properties:
              enabledState: Enabled
      - operationId: AFDOrigins_ListByOriginGroup

      # AFD Routes & Rules
      - operationId: Routes_Create
        parameters:
          route:
            properties:
              customDomains: []
              originGroup:
                id: /subscriptions/$(subscriptionId)/resourceGroups/$(resourceGroupName)/providers/Microsoft.Cdn/profiles/$(profileName)/originGroups/$(originGroupName)
              ruleSets: []
              supportedProtocols:
                - Http
                - Https
              patternsToMatch:
                - "/*"
              forwardingProtocol: MatchRequest
              linkToDefaultDomain: Enabled
              httpsRedirect: Enabled
              enabledState: Enabled
      - operationId: RuleSets_Create
      - operationId: RuleSets_Get
      - operationId: RuleSets_Create
        parameters:
          ruleSetName: ruleSet2
      - operationId: RuleSets_ListByProfile
      - operationId: Rules_Create
      - operationId: Rules_Get
      - operationId: Rules_Update
        parameters:
          ruleUpdateProperties:
            properties:
              order: 1
              actions:
                - name: ModifyResponseHeader
                  parameters:
                    typeName: DeliveryRuleHeaderActionParameters
                    headerAction: Overwrite
                    headerName: X-CDN
                    value: MSFT
      - operationId: Rules_Create
        parameters:
          ruleName: rule2
        variables:
          rule:
            type: object
            patches:
              - replace: /properties/order
                value: 2
              - replace: /properties/conditions/0/parameters/negateCondition
                value: true
              - replace: /properties/actions/0/parameters/value
                value: AZURE
      - operationId: Rules_ListByRuleSet
      - operationId: Routes_Update
        parameters:
          routeUpdateProperties:
            properties:
              ruleSets:
                - id: /subscriptions/$(subscriptionId)/resourceGroups/$(resourceGroupName)/providers/Microsoft.Cdn/profiles/$(profileName)/ruleSets/$(ruleSetName)
      - operationId: Routes_Get

      - operationId: LogAnalytics_GetLogAnalyticsLocations
        parameters:
          metrics: clientRequestCount
          granularity: PT5M
          groupBy: httpStatusCode
          dateTimeBegin: "2022-03-15T05:00:00.000Z"
          dateTimeEnd: "2022-03-15T06:00:00.000Z"

cleanUpSteps:
  - operationId: Rules_Delete
    parameters:
      ruleName: rule2
  - operationId: Routes_Delete
  - operationId: AFDOrigins_Delete
  - operationId: AFDOriginGroups_Delete
  - operationId: AFDEndpoints_Delete
  - operationId: Profiles_Delete
